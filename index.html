<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Teng Image Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background:#0b1020; color:#e7ecf3; }
    h1, h2 { text-align: center; }
    .tabs { display: flex; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
    .tab { padding: 12px 24px; cursor: pointer; border: 1px solid #ccc; margin: 5px; border-radius:8px; font-size:16px; }
    .tab.active { background: #007bff; color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    textarea { width: 100%; height: 150px; font-size:14px; }
    img.preview { max-width: 100%; max-height: 200px; display: block; margin: 10px auto; }
    button { margin: 12px; padding:12px 20px; font-size:16px; border-radius:8px; cursor:pointer; }
    select, input[type="number"], input[type="text"], input[type="range"] {
      padding:8px; border-radius:6px; border:1px solid #27314a; background:#141a2e; color:#e7ecf3; font-size:14px;
    }
    .card{background:#141a2e;border:1px solid #27314a;border-radius:12px;padding:16px;margin:12px auto;max-width:1000px}
    .log{font-family:monospace;background:#0a0f22;border:1px solid #27314a;border-radius:8px;padding:10px;height:160px;overflow:auto}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .thumb{background:#0c1226;border:1px solid #27314a;border-radius:12px;overflow:hidden}
    .thumb img{width:100%;display:block}
    .thumb .meta{padding:8px;font-size:12px;color:#9aa4b2;text-align:center}
    .drop{border:2px dashed #2b3b66;border-radius:10px;padding:18px;text-align:center;color:#c7d2fe;background:#0d1330;margin-bottom:10px}
    .drop.dragover{outline:2px solid #5eead4}
    label{display:block;margin-top:10px;font-size:14px;color:#9aa4b2}
    @media (max-width:600px){
      button{width:90%; margin:10px auto; display:block;}
      .tab{flex:1 1 45%; text-align:center;}
      .thumbs{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));}
    }
  </style>

  <!-- 相依套件 -->
  <script src="https://cdn.jsdelivr.net/npm/pica@8.0.0/dist/pica.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/mini.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/piexif.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>
</head>
<body>
  <h1>Teng Image Tools</h1>

  <!-- 分頁切換 -->
  <div class="tabs">
    <div class="tab active" data-tab="resizer">尺寸格式調整</div>
    <div class="tab" data-tab="base64">Base64轉換</div>
  </div>

  <!-- 圖片尺寸調整區塊 -->
  <div id="resizer" class="tab-content active">
    <section class="card">
      <h2>圖片尺寸/格式調整器</h2>
      <div class="drop" id="drop">拖曳圖片或資料夾到這裡</div>
      <input id="fileFiles" type="file" accept="image/*,.heic,.heif" multiple>
      <input id="fileFolder" type="file" webkitdirectory>

      <h3>執行</h3>
      <button id="process">開始處理</button>
      <button id="clear">清空</button>

      <h3>輸出選項</h3>
      <label>輸出格式
        <select id="format">
          <option value="keep">維持原格式</option>
          <option value="image/jpeg" selected>JPEG</option>
          <option value="image/png">PNG</option>
          <option value="image/webp">WebP</option>
        </select>
      </label>

      <label>寬度
        <select id="widthSelect">
          <option value="0" selected>原尺寸</option>
          <option value="512">512</option>
          <option value="1024">1024</option>
          <option value="1280">1280</option>
          <option value="custom">自訂</option>
        </select>
        <input id="widthCustom" type="number" placeholder="輸入寬度" style="width:100px; display:none;">
      </label>

      <label>高度
        <select id="heightSelect">
          <option value="0" selected>原尺寸</option>
          <option value="512">512</option>
          <option value="1024">1024</option>
          <option value="1280">1280</option>
          <option value="custom">自訂</option>
        </select>
        <input id="heightCustom" type="number" placeholder="輸入高度" style="width:100px; display:none;">
      </label>

      <label><input id="lock" type="checkbox" checked> 維持長寬比</label>
      <label><input id="fit" type="checkbox" checked> 以最長邊等比縮放 (fit)</label>
      <label>縮放比例 (%) <input id="scale" type="range" min="10" max="200" value="100"><span id="scaleLabel">100%</span></label>
      <label>品質 (JPEG/WebP) <input id="quality" type="range" min="50" max="100" value="90"><span id="qualityLabel">90%</span></label>
      <label>DPI <input id="dpi" type="number" placeholder="例如 300"> <input id="writeDpi" type="checkbox"> 寫入 JPEG EXIF DPI</label>

      <h3>預覽</h3>
      <div id="thumbs" class="thumbs"></div>
      <h3>日誌</h3>
      <div id="log" class="log"></div>
    </section>
  </div>

  <!-- Base64 工具 -->
  <div id="base64" class="tab-content">
    <section class="card">
      <h2>圖片 ➝ Base64</h2>
      <input type="file" id="imgToBase64" accept="image/*">
      <button onclick="downloadBase64()">下載 Base64 txt</button>
      <textarea id="base64Output" placeholder="這裡會顯示 Base64 編碼"></textarea>
      <img id="previewBase64Img" class="preview">

      <hr>
      
      <h2>Base64 ➝ 圖片</h2>
      <textarea id="base64Input" placeholder="貼上 Base64 字串（或直接選檔）"></textarea>
      <input type="file" id="base64File" accept=".txt">

      <!-- 進度條 -->
      <div id="progressContainer" style="width:100%; background:#ddd; height:10px; display:none; margin:10px 0;">
        <div id="progressBar" style="width:0%; height:100%; background:#4caf50; text-align:center; color:white; font-size:12px;">0%</div>
      </div>

      <a id="downloadRestored" style="display:none" download="restored.png">下載圖片</a>
      <img id="restoredImg" class="preview">
    </section>
  </div>

<script>
  // --- 分頁切換 ---
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById(tab.dataset.tab).classList.add("active");
    });
  });

  // --- 寬度/高度下拉自訂 ---
  const widthSelect = document.getElementById('widthSelect');
  const widthCustom = document.getElementById('widthCustom');
  widthSelect.addEventListener('change', () => {
    widthCustom.style.display = (widthSelect.value === 'custom') ? 'inline-block' : 'none';
  });
  const heightSelect = document.getElementById('heightSelect');
  const heightCustom = document.getElementById('heightCustom');
  heightSelect.addEventListener('change', () => {
    heightCustom.style.display = (heightSelect.value === 'custom') ? 'inline-block' : 'none';
  });

  // --- Base64 轉換 ---
  function showProgress() {
    const container = document.getElementById("progressContainer");
    const bar = document.getElementById("progressBar");
    container.style.display = "block";
    bar.style.width = "0%";
    bar.textContent = "0%";
    let progress = 0;
    const interval = setInterval(() => {
      progress += 20;
      if (progress >= 90) clearInterval(interval);
      bar.style.width = progress + "%";
      bar.textContent = progress + "%";
    }, 200);
  }
  function hideProgress() {
    const container = document.getElementById("progressContainer");
    const bar = document.getElementById("progressBar");
    bar.style.width = "100%";
    bar.textContent = "100%";
    setTimeout(()=>container.style.display="none",500);
  }
  function detectFormat(base64) {
    if (base64.startsWith("iVBORw0KGgo")) return "png";
    if (base64.startsWith("/9j/")) return "jpeg";
    if (base64.startsWith("UklGR")) return "webp";
    return "png";
  }
  function convertBase64ToImage() {
    let raw = document.getElementById("base64Input").value.trim();
    if (!raw) return;
    let format;
    let base64 = raw;
    if (!raw.startsWith("data:image/")) {
      format = detectFormat(raw);
      base64 = `data:image/${format};base64,` + raw;
    } else {
      const match = raw.match(/^data:image\/(png|jpeg|jpg|webp);base64,/);
      format = match ? match[1] : "png";
      base64 = raw;
    }
    const img = document.getElementById("restoredImg");
    img.onload = () => hideProgress();
    img.src = base64;
    const link = document.getElementById("downloadRestored");
    link.href = base64;
    link.download = "restored." + format;
    link.style.display = "inline-block";
  }
  document.getElementById("base64File").addEventListener("change", e => {
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader(); showProgress();
    reader.onload = evt => {
      document.getElementById("base64Input").value = evt.target.result.trim();
      convertBase64ToImage();
    };
    reader.readAsText(file);
  });
  document.getElementById("base64Input").addEventListener("input", () => {
    if(document.getElementById("base64Input").value.trim()!==""){ showProgress(); convertBase64ToImage(); }
  });

  function downloadBase64() {
    const txt = document.getElementById("base64Output").value;
    if(!txt) return;
    const blob = new Blob([txt], {type:"text/plain"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "image_base64.txt";
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),2000);
  }
</script>
</body>
</html>
